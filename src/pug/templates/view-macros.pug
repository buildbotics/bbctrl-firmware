//-/////////////////////////////////////////////////////////////////////////////
//-                                                                           //
//-               This file is part of the Buildbotics firmware.              //
//-                                                                           //
//-      Copyright (c) 2015 - 2023, Buildbotics LLC, All rights reserved.     //
//-                                                                           //
//-       This Source describes Open Hardware and is licensed under the       //
//-                               CERN-OHL-S v2.                              //
//-                                                                           //
//-       You may redistribute and modify this Source and make products       //
//-  using it under the terms of the CERN-OHL-S v2 (https:/cern.ch/cern-ohl). //
//-         This Source is distributed WITHOUT ANY EXPRESS OR IMPLIED         //
//-  WARRANTY, INCLUDING OF MERCHANTABILITY, SATISFACTORY QUALITY AND FITNESS //
//-   FOR A PARTICULAR PURPOSE. Please see the CERN-OHL-S v2 for applicable   //
//-                                conditions.                                //
//-                                                                           //
//-              Source location: https://github.com/buildbotics              //
//-                                                                           //
//-    As per CERN-OHL-S v2 section 4, should You produce hardware based on   //
//-  these sources, You must maintain the Source Location clearly visible on  //
//-  the external case of the CNC Controller or other product you make using  //
//-                                this Source.                               //
//-                                                                           //
//-              For more information, email info@buildbotics.com             //
//-                                                                           //
//-/////////////////////////////////////////////////////////////////////////////

script#view-macros-template(type="text/x-template")
  .macros-view
    //- Navigation bar (dark style)
    nav.navbar
      a.nav-item(href="#macros") Macros
      a.nav-item(href="#macros:tabs") Tabs
      
      .spacer
      
      .actions
        //- Add button changes based on view
        bbutton(v-if="view === 'macros'", @click="add", icon="plus", text="Add Macro",
          :disabled="!$root.authorized",
          title="Add a new macro")
        bbutton(v-if="view === 'tabs'", @click="add_tab", icon="plus", text="Add Tab",
          :disabled="!$root.authorized",
          title="Add a new tab")
        
        //- Login/Save button area (far right)
        bbutton(v-if="!$root.authorized", @click="$root.login()", 
          icon="sign-in", text="Login",
          title="Login to make changes")
        bbutton(v-if="$root.authorized && modified", @click="save", 
          icon="save", text="Save", success,
          title="Save macro configuration")
        .save-status(v-if="$root.authorized && !modified")
          .fa.fa-check
          span Saved

    //- Summary bar
    .summary-bar
      .summary-item
        .summary-label Total Macros
        .summary-value {{macros.length}}
      .summary-item
        .summary-label Visible
        .summary-value {{visible_macro_count}}
      .summary-item
        .summary-label Tabs
        .summary-value {{macro_tabs.length}}

    //- Macros View (default)
    .macros-content(v-if="view === 'macros'")
      h2 Macro Configuration
      
      p.help-text.
        Macros are programs that you can run by clicking the corresponding
        button on the #[a(href="#control") control page]. Configure the button 
        appearance, assign to tabs, and set visibility and confirmation options.

      //- Macro list
      .macro-list(v-if="macros.length")
        .macro-header
          .col-grip
          .col-index
          .col-visibility
            .fa.fa-eye(title="Visible")
          .col-confirm
            .fa.fa-check-circle(title="Confirm")
          .col-tab Tab
          .col-color Color
          .col-spacer
          .col-actions
        
        .macro-row(v-for="macro in macros", draggable="true",
          @dragstart="dragstart", @mousedown="mousedown",
          @drag="drag($index)", @dragover.prevent="",
          @drop.prevent="drop($index)")
          
          .row-main
            .col-grip
              .grip
            
            .col-index {{$index + 1}}
            
            .col-visibility
              input(type="checkbox", :checked="is_visible(macro)",
                @change="toggle_visibility($index)",
                :title="is_visible(macro) ? 'Visible on control page' : 'Hidden from control page'")
            
            .col-confirm
              input(type="checkbox", :checked="requires_confirm(macro)",
                @change="toggle_confirm($index)",
                :title="requires_confirm(macro) ? 'Confirmation required' : 'Runs immediately'")
            
            .col-tab
              select(@change="set_macro_tab($index, $event.target.value)",
                title="Assign macro to a tab")
                option(v-for="tab in macro_tabs", :value="tab.id",
                  :selected="get_macro_tab(macro) === tab.id") {{tab.name}}
            
            .col-color
              color-picker(:value.sync="macro.color", @change="change",
                title="Set the macro button color.")
            
            .col-spacer
            
            .col-actions
              .fa.fa-trash(@click="remove($index)",
                title="Delete this macro")
          
          .row-details
            .detail-group
              label Name
              input.name(@change="change", v-model="macro.name",
                title="Set the macro button name.",
                placeholder="Button name")
            
            .detail-group.detail-file
              label File
              .file-input
                input.path(@click="open($index)", :value="macro.path", readonly,
                  title="Select the macro file",
                  placeholder="Click to select file...")
                .fa.fa-folder-open(@click="open($index)",
                  title="Select the macro file.")
      //- Empty state
      .empty-state(v-else)
        .fa.fa-file-code-o
        p No macros configured yet.
        bbutton(@click="add", icon="plus", text="Add Your First Macro")

      //- Help text
      .help-section(v-if="macros.length")
        h3 Tips
        ul
          li Use the #[strong eye icon] checkbox to show/hide macros on the control page
          li The #[strong question mark] checkbox controls whether confirmation is required before running
          li Drag macros by the grip handle to reorder them
          li Assign macros to tabs to organize them into groups

    //- Tabs View
    .macros-content(v-if="view === 'tabs'")
      h2 Macro Tabs
      
      p.help-text.
        Create tabs to organize your macros into focused groups. 
        On the control page, only macros from the selected tab will be shown.

      //- Tab list
      .tab-list(v-if="macro_tabs.length")
        .tab-row(v-for="tab in macro_tabs", draggable="true",
          @dragstart="tab_dragstart", @mousedown="tab_mousedown",
          @drag="tab_drag($index)", @dragover.prevent="",
          @drop.prevent="tab_drop($index)")
          
          .grip
          
          input.tab-name(v-model="tab.name", @change="change",
            title="Tab name displayed on control page",
            placeholder="Tab name")
          
          .tab-macro-count(title="Number of macros in this tab").
            {{count_macros_in_tab(tab.id)}} macros
          
          .tab-actions
            .fa.fa-trash(@click="remove_tab($index)",
              :title="'Delete tab (macros will move to first tab)'",
              :class="{disabled: macro_tabs.length <= 1}")

      //- Help text
      .help-section
        h3 How Tabs Work
        ul
          li The first tab is the default - new macros are assigned here automatically
          li Deleting a tab moves its macros to the first remaining tab
          li On the control page, click tab names to switch between macro groups
          li Tabs only appear on the control page when you have more than one
